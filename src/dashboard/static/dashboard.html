<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Travliaq Testing Dashboard</title>
<style>
  :root {
    --bg: #0f172a; --bg2: #1e293b; --bg3: #334155;
    --text: #e2e8f0; --text2: #94a3b8; --text3: #64748b;
    --accent: #3b82f6; --green: #22c55e; --red: #ef4444;
    --yellow: #eab308; --purple: #a855f7;
    --radius: 8px;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); }

  /* Layout */
  .app { display: grid; grid-template-rows: 56px 1fr 48px; height: 100vh; }
  .header { background: var(--bg2); display: flex; align-items: center; padding: 0 20px; gap: 16px; border-bottom: 1px solid var(--bg3); }
  .header h1 { font-size: 16px; font-weight: 600; }
  .main { display: grid; grid-template-columns: 280px 1fr; overflow: hidden; }
  .footer { background: var(--bg2); display: flex; align-items: center; padding: 0 20px; gap: 24px; font-size: 13px; color: var(--text2); border-top: 1px solid var(--bg3); }

  /* Header badges */
  .badge { padding: 3px 10px; border-radius: 12px; font-size: 12px; font-weight: 500; }
  .badge-idle { background: var(--bg3); color: var(--text2); }
  .badge-running { background: #1e3a5f; color: var(--accent); animation: pulse 2s infinite; }
  .badge-completed { background: #14532d; color: var(--green); }
  .badge-failed { background: #450a0a; color: var(--red); }
  .badge-timeout { background: #422006; color: var(--yellow); }
  .badge-pending { background: var(--bg3); color: var(--text3); }
  @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.6; } }

  .elapsed { margin-left: auto; font-size: 13px; color: var(--text2); font-variant-numeric: tabular-nums; }

  /* Sidebar */
  .sidebar { background: var(--bg2); border-right: 1px solid var(--bg3); overflow-y: auto; padding: 12px; }
  .sidebar h2 { font-size: 12px; text-transform: uppercase; color: var(--text3); margin-bottom: 8px; letter-spacing: 0.5px; }
  .persona-card { padding: 10px 12px; border-radius: var(--radius); cursor: pointer; margin-bottom: 4px; transition: background 0.15s; display: flex; align-items: center; gap: 10px; }
  .persona-card:hover { background: var(--bg3); }
  .persona-card.active { background: var(--bg3); border-left: 3px solid var(--accent); }
  .persona-icon { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
  .persona-icon.pending { background: var(--text3); }
  .persona-icon.running { background: var(--accent); animation: pulse 1.5s infinite; }
  .persona-icon.completed { background: var(--green); }
  .persona-icon.failed { background: var(--red); }
  .persona-icon.timeout { background: var(--yellow); }
  .persona-info { flex: 1; min-width: 0; }
  .persona-name { font-size: 13px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .persona-meta { font-size: 11px; color: var(--text3); }
  .persona-detail { font-size: 10px; color: var(--text3); margin-top: 2px; }
  .persona-score { font-size: 14px; font-weight: 700; }
  .score-good { color: var(--green); }
  .score-mid { color: var(--yellow); }
  .score-bad { color: var(--red); }
  .loop-indicator { font-size: 10px; color: var(--purple); margin-left: 4px; }

  /* Main panel */
  .panel { overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 16px; }

  /* Cards */
  .card { background: var(--bg2); border-radius: var(--radius); padding: 16px; border: 1px solid var(--bg3); }
  .card h3 { font-size: 13px; text-transform: uppercase; color: var(--text3); margin-bottom: 12px; letter-spacing: 0.5px; }
  .card h4 { font-size: 12px; margin-bottom: 6px; }

  /* Active run monitor */
  .run-header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
  .run-header .name { font-size: 18px; font-weight: 600; }
  .run-header .lang { font-size: 12px; padding: 2px 8px; border-radius: 10px; background: var(--bg3); color: var(--text2); }

  /* Stage progress bar */
  .stages { display: flex; gap: 4px; margin-bottom: 8px; }
  .stage { flex: 1; border-radius: 4px; background: var(--bg3); display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; color: var(--text3); transition: all 0.3s; padding: 6px 2px; }
  .stage.done { background: #14532d; color: var(--green); }
  .stage.active { background: #1e3a5f; color: var(--accent); animation: pulse 2s infinite; }
  .stage.failed-stage { background: #450a0a; color: var(--red); }
  .stage .stage-time { font-size: 8px; margin-top: 2px; opacity: 0.7; }

  /* Metadata grid */
  .meta-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; }
  .meta-label { font-size: 11px; color: var(--text3); text-transform: uppercase; }
  .meta-value { font-size: 14px; font-weight: 500; margin-top: 2px; }

  /* Pills */
  .pills { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 4px; }
  .pill { font-size: 11px; padding: 2px 8px; border-radius: 10px; background: var(--bg3); color: var(--text2); }

  /* Persona Profile Card */
  .persona-profile { display: grid; grid-template-columns: 80px 1fr; gap: 16px; align-items: start; }
  .persona-avatar { width: 80px; height: 80px; border-radius: 50%; border: 3px solid var(--bg3); background: var(--bg3); }
  .persona-header-info { display: flex; flex-direction: column; gap: 3px; }
  .persona-header-info .pname { font-size: 20px; font-weight: 700; }
  .persona-header-info .age-lang { font-size: 13px; color: var(--text2); }
  .persona-role { font-size: 13px; color: var(--text2); line-height: 1.5; margin-top: 10px; font-style: italic; border-left: 3px solid var(--bg3); padding-left: 12px; }

  .trait-pill { font-size: 11px; padding: 3px 10px; border-radius: 12px; font-weight: 500; }
  .trait-pill:nth-child(4n+1) { background: #1e3a5f; color: #60a5fa; }
  .trait-pill:nth-child(4n+2) { background: #14532d; color: #4ade80; }
  .trait-pill:nth-child(4n+3) { background: #3b0764; color: #c084fc; }
  .trait-pill:nth-child(4n+4) { background: #422006; color: #fbbf24; }

  .conv-style-grid { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 4px; }
  .conv-style-item { font-size: 11px; padding: 3px 8px; border-radius: 6px; background: var(--bg); color: var(--text2); display: flex; align-items: center; gap: 4px; }

  .travel-detail-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); gap: 8px; margin-top: 8px; }
  .travel-detail-item { padding: 8px 10px; background: var(--bg); border-radius: var(--radius); }
  .travel-detail-item .td-label { font-size: 10px; text-transform: uppercase; color: var(--text3); }
  .travel-detail-item .td-value { font-size: 13px; font-weight: 500; margin-top: 2px; }

  .goals-timeline { display: flex; flex-direction: column; gap: 4px; margin-top: 8px; }
  .goal-row { display: flex; align-items: flex-start; gap: 8px; padding: 6px 8px; background: var(--bg); border-radius: var(--radius); }
  .goal-indicator { font-size: 14px; flex-shrink: 0; line-height: 1.4; }
  .goal-phase { font-size: 11px; font-weight: 600; color: var(--accent); min-width: 90px; text-transform: capitalize; }
  .goal-desc { font-size: 12px; color: var(--text2); flex: 1; line-height: 1.4; }
  .goal-widgets { display: flex; flex-wrap: wrap; gap: 3px; margin-top: 3px; }
  .goal-widget-pill { font-size: 10px; padding: 1px 6px; border-radius: 8px; background: var(--bg3); color: var(--text3); }

  .weight-badges { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 4px; }
  .weight-badge { font-size: 10px; padding: 2px 6px; border-radius: 8px; background: #3b0764; color: #c084fc; }

  .section-label { font-size: 11px; color: var(--text3); text-transform: uppercase; margin-top: 14px; margin-bottom: 4px; }

  /* Enhanced Live Step */
  .thinking-snippet { margin-top: 8px; padding: 8px 12px; background: var(--bg); border-left: 3px solid var(--purple); border-radius: 0 var(--radius) var(--radius) 0; font-size: 12px; color: var(--text2); font-style: italic; line-height: 1.5; }
  .live-actions-feed { display: flex; flex-direction: column; gap: 3px; margin-top: 8px; }
  .live-action-row { display: flex; align-items: center; gap: 8px; font-size: 12px; padding: 2px 0; }
  .live-action-step { color: var(--text3); font-variant-numeric: tabular-nums; min-width: 36px; font-weight: 600; }
  .live-action-name { color: var(--text2); }
  .live-action-url { color: var(--text3); font-size: 10px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 300px; }

  /* Justification cards */
  .justification-card { margin-top: 8px; padding: 10px 12px; background: var(--bg); border-radius: var(--radius); border-left: 3px solid; }
  .justification-card .axis-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
  .justification-card .axis-name { font-size: 12px; font-weight: 600; text-transform: capitalize; }
  .justification-card .axis-score { font-size: 14px; font-weight: 700; font-variant-numeric: tabular-nums; }
  .justification-card .axis-text { font-size: 12px; color: var(--text2); line-height: 1.5; }

  /* Phase comparison */
  .phase-comparison { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
  .phase-chip { font-size: 11px; padding: 3px 10px; border-radius: 12px; font-weight: 500; }
  .phase-chip.reached { background: #14532d; color: var(--green); }
  .phase-chip.missed { background: #450a0a; color: var(--red); opacity: 0.7; }

  /* Scores */
  .scores-layout { display: grid; grid-template-columns: 300px 1fr; gap: 20px; }
  @media (max-width: 900px) { .scores-layout { grid-template-columns: 1fr; } }
  .overall-score { text-align: center; margin-bottom: 12px; }
  .overall-score .number { font-size: 48px; font-weight: 700; }
  .overall-score .label { font-size: 12px; color: var(--text3); }
  canvas#radar { display: block; margin: 0 auto; }
  .score-row { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
  .score-row .axis { font-size: 12px; color: var(--text2); width: 140px; text-align: right; }
  .score-bar-bg { flex: 1; height: 8px; background: var(--bg3); border-radius: 4px; overflow: hidden; }
  .score-bar { height: 100%; border-radius: 4px; transition: width 0.5s; }
  .score-row .val { font-size: 12px; width: 32px; font-weight: 600; font-variant-numeric: tabular-nums; }

  /* Lists */
  .detail-list { margin-top: 8px; }
  .detail-list li { font-size: 13px; color: var(--text2); margin-bottom: 4px; padding-left: 12px; position: relative; }
  .detail-list li::before { content: ''; position: absolute; left: 0; top: 7px; width: 5px; height: 5px; border-radius: 50%; }
  .detail-list.strengths li::before { background: var(--green); }
  .detail-list.frustrations li::before { background: var(--red); }
  .detail-list.suggestions li::before { background: var(--accent); }

  /* Event log */
  .event-log { max-height: 300px; overflow-y: auto; font-family: 'Cascadia Code', 'Fira Code', monospace; font-size: 12px; }
  .event-log .entry { padding: 3px 0; border-bottom: 1px solid rgba(255,255,255,0.03); display: flex; gap: 8px; }
  .event-log .time { color: var(--text3); flex-shrink: 0; width: 65px; }
  .event-log .persona { color: var(--accent); flex-shrink: 0; width: 120px; overflow: hidden; text-overflow: ellipsis; }
  .event-log .msg { color: var(--text2); }
  .event-log .msg.error { color: var(--red); }
  .event-log .msg.success { color: var(--green); }
  .event-log .msg.loop { color: var(--purple); }

  /* Collapsible sections */
  .collapsible-header { cursor: pointer; display: flex; align-items: center; justify-content: space-between; }
  .collapsible-header .arrow { font-size: 10px; transition: transform 0.2s; }
  .collapsible-header .arrow.open { transform: rotate(90deg); }
  .collapsible-body { display: none; max-height: 400px; overflow-y: auto; font-family: 'Cascadia Code', 'Fira Code', monospace; font-size: 12px; line-height: 1.6; color: var(--text2); white-space: pre-wrap; margin-top: 8px; padding: 8px; background: var(--bg); border-radius: 4px; }
  .collapsible-body.open { display: block; }

  /* Screenshots */
  .screenshots-gallery { display: flex; flex-wrap: wrap; gap: 8px; }
  .screenshot-thumb { width: 120px; cursor: pointer; border-radius: 4px; overflow: hidden; border: 1px solid var(--bg3); transition: border-color 0.15s; }
  .screenshot-thumb:hover { border-color: var(--accent); }
  .screenshot-thumb img { width: 100%; height: 80px; object-fit: cover; display: block; }
  .screenshot-label { font-size: 10px; color: var(--text3); text-align: center; padding: 2px; }
  .screenshot-lightbox { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 1000; cursor: pointer; }
  .screenshot-lightbox img { max-width: 90%; max-height: 90%; border-radius: var(--radius); }

  /* Empty states */
  .empty { text-align: center; padding: 40px; color: var(--text3); }
  .empty .icon { font-size: 48px; margin-bottom: 12px; }

  /* Results browser */
  .results-table { width: 100%; border-collapse: collapse; }
  .results-table th { font-size: 11px; text-transform: uppercase; color: var(--text3); text-align: left; padding: 8px; border-bottom: 1px solid var(--bg3); }
  .results-table td { padding: 8px; font-size: 13px; border-bottom: 1px solid rgba(255,255,255,0.03); cursor: pointer; }
  .results-table tr:hover td { background: var(--bg3); }

  /* Reconnecting banner */
  .reconnecting { display: none; background: var(--yellow); color: #000; text-align: center; padding: 4px; font-size: 12px; font-weight: 500; }
  .reconnecting.show { display: block; }

  /* Enhanced Persona Identity Card */
  .persona-profile-enhanced { display: grid; grid-template-columns: 120px 1fr; gap: 20px; align-items: start; }
  .persona-avatar-lg { width: 120px; height: 120px; border-radius: 50%; border: 4px solid var(--accent); background: var(--bg3); box-shadow: 0 0 20px rgba(59,130,246,0.15); }
  .persona-role-quote { font-size: 14px; color: var(--text2); line-height: 1.6; margin-top: 12px; padding: 12px 16px; background: var(--bg); border-left: 4px solid var(--purple); border-radius: 0 var(--radius) var(--radius) 0; font-style: italic; }

  /* Conversation style meters */
  .conv-style-visual { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 6px; }
  .style-meter { display: flex; flex-direction: column; align-items: center; gap: 2px; padding: 6px 10px; background: var(--bg); border-radius: var(--radius); min-width: 80px; }
  .style-meter .meter-label { font-size: 10px; color: var(--text3); text-transform: uppercase; }
  .style-meter .meter-bar { width: 60px; height: 4px; background: var(--bg3); border-radius: 2px; overflow: hidden; }
  .style-meter .meter-fill { height: 100%; border-radius: 2px; background: var(--accent); }
  .style-meter .meter-value { font-size: 11px; color: var(--text2); font-weight: 500; }

  /* Interests card */
  .interests-grid { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; }
  .interest-tag { font-size: 11px; padding: 4px 10px; border-radius: 12px; font-weight: 500; display: flex; align-items: center; gap: 4px; }
  .interest-tag.destination { background: #14532d; color: #4ade80; }
  .interest-tag.activity { background: #1e3a5f; color: #60a5fa; }
  .interest-tag.avoided { background: #450a0a; color: #ef4444; text-decoration: line-through; }
  .group-visual { display: flex; align-items: center; gap: 4px; margin-top: 6px; padding: 8px 12px; background: var(--bg); border-radius: var(--radius); }
  .group-icon { font-size: 18px; }
  .badge-row { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; }
  .info-badge { font-size: 11px; padding: 4px 10px; border-radius: 12px; background: var(--bg); color: var(--text2); border: 1px solid var(--bg3); display: flex; align-items: center; gap: 4px; }
  .budget-bar-container { margin-top: 8px; padding: 8px 12px; background: var(--bg); border-radius: var(--radius); }
  .budget-bar-track { height: 8px; background: var(--bg3); border-radius: 4px; position: relative; margin-top: 4px; }
  .budget-bar-fill { position: absolute; height: 100%; background: linear-gradient(90deg, var(--green), var(--yellow)); border-radius: 4px; }
  .budget-labels { display: flex; justify-content: space-between; font-size: 10px; color: var(--text3); margin-top: 2px; }

  /* KPI Metrics */
  .kpi-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; }
  .kpi-item { padding: 12px; background: var(--bg); border-radius: var(--radius); text-align: center; border: 1px solid var(--bg3); }
  .kpi-item .kpi-value { font-size: 28px; font-weight: 700; font-variant-numeric: tabular-nums; line-height: 1.2; }
  .kpi-item .kpi-label { font-size: 11px; color: var(--text3); text-transform: uppercase; margin-top: 4px; }
  .kpi-item .kpi-sub { font-size: 10px; color: var(--text3); margin-top: 2px; }

  /* SWOT Matrix */
  .swot-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .swot-quadrant { padding: 12px; border-radius: var(--radius); border: 1px solid; }
  .swot-quadrant h4 { font-size: 12px; text-transform: uppercase; margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
  .swot-quadrant ul { list-style: none; }
  .swot-quadrant li { font-size: 12px; color: var(--text2); padding: 3px 0; padding-left: 14px; position: relative; line-height: 1.5; }
  .swot-quadrant li::before { content: ''; position: absolute; left: 0; top: 8px; width: 6px; height: 6px; border-radius: 50%; }
  .swot-strengths { background: rgba(34,197,94,0.05); border-color: rgba(34,197,94,0.3); }
  .swot-strengths h4 { color: var(--green); }
  .swot-strengths li::before { background: var(--green); }
  .swot-weaknesses { background: rgba(239,68,68,0.05); border-color: rgba(239,68,68,0.3); }
  .swot-weaknesses h4 { color: var(--red); }
  .swot-weaknesses li::before { background: var(--red); }
  .swot-opportunities { background: rgba(59,130,246,0.05); border-color: rgba(59,130,246,0.3); }
  .swot-opportunities h4 { color: var(--accent); }
  .swot-opportunities li::before { background: var(--accent); }
  .swot-threats { background: rgba(234,179,8,0.05); border-color: rgba(234,179,8,0.3); }
  .swot-threats h4 { color: var(--yellow); }
  .swot-threats li::before { background: var(--yellow); }

  /* Post-Execution Checklist */
  .checklist { display: flex; flex-direction: column; gap: 8px; }
  .checklist-item { display: flex; align-items: center; gap: 12px; padding: 10px 14px; background: var(--bg); border-radius: var(--radius); border-left: 3px solid; }
  .checklist-item.pass { border-left-color: var(--green); }
  .checklist-item.fail { border-left-color: var(--red); }
  .checklist-icon { font-size: 20px; flex-shrink: 0; }
  .checklist-text { flex: 1; }
  .checklist-text .cl-label { font-size: 13px; font-weight: 500; }
  .checklist-text .cl-desc { font-size: 11px; color: var(--text3); margin-top: 1px; }

  /* UX Feedback sections */
  .ux-feedback-sections { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px; }
  @media (max-width: 900px) { .ux-feedback-sections { grid-template-columns: 1fr; } }
  .ux-section { padding: 10px 12px; border-radius: var(--radius); border-left: 3px solid; }
  .ux-section h4 { font-size: 11px; text-transform: uppercase; margin-bottom: 6px; }
  .ux-section p { font-size: 12px; color: var(--text2); line-height: 1.5; }
  .ux-good { background: rgba(34,197,94,0.05); border-left-color: var(--green); }
  .ux-good h4 { color: var(--green); }
  .ux-bad { background: rgba(239,68,68,0.05); border-left-color: var(--red); }
  .ux-bad h4 { color: var(--red); }
  .ux-threats { background: rgba(234,179,8,0.05); border-left-color: var(--yellow); }
  .ux-threats h4 { color: var(--yellow); }
  .ux-opportunities { background: rgba(59,130,246,0.05); border-left-color: var(--accent); }
  .ux-opportunities h4 { color: var(--accent); }
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <h1>Travliaq Testing Dashboard</h1>
    <span id="batchBadge" class="badge badge-idle">IDLE</span>
    <span id="batchId" style="font-size:12px;color:var(--text3)"></span>
    <div class="elapsed" id="elapsed"></div>
  </div>

  <div class="reconnecting" id="reconnecting">Reconnecting to server...</div>

  <div class="main">
    <div class="sidebar">
      <h2>Personas</h2>
      <div id="personaList"></div>
    </div>

    <div class="panel" id="panel">
      <div class="empty" id="emptyState">
        <div class="icon">&#128640;</div>
        <p>Waiting for batch to start...</p>
        <p style="font-size:13px;margin-top:8px">Start with: <code>python cli.py dashboard --run-batch --headless</code></p>
      </div>
    </div>
  </div>

  <div class="footer">
    <span id="footerProgress">0/0 completed</span>
    <span id="footerAvg"></span>
    <span id="footerTime"></span>
  </div>
</div>

<script>
// ---------------------------------------------------------------------------
// State
// ---------------------------------------------------------------------------
let state = { batch_id: null, status: 'idle', personas: {}, current_persona: null, current_stage: null, started_at: null, events_log: [] };
let selectedPersona = null;
let startedAt = null;
let elapsedTimer = null;
let resultCache = {};
let personaMetadata = {};

const STAGES = [
  { key: '0/5', label: 'Health' },
  { key: '1/5', label: 'Agent' },
  { key: '2/5', label: 'Run' },
  { key: '3/5', label: 'Extract' },
  { key: '4/5', label: 'Eval' },
  { key: '5/5', label: 'Report' },
];
const AXES = ['fluidity','relevance','visual_clarity','error_handling','conversation_memory','widget_usability','map_interaction','response_speed','personality_match'];

// ---------------------------------------------------------------------------
// SSE Connection
// ---------------------------------------------------------------------------
let evtSource = null;
function connectSSE() {
  evtSource = new EventSource('/api/stream');
  evtSource.onmessage = function(e) {
    const data = JSON.parse(e.data);
    document.getElementById('reconnecting').classList.remove('show');

    if (data.type === 'state_snapshot') {
      state = data.data;
      if (state.started_at) startedAt = new Date(state.started_at);
      renderAll();
      return;
    }

    const t = data.type;
    if (t === 'batch_started') {
      state.batch_id = data.batch_id;
      state.status = 'running';
      state.started_at = data.timestamp;
      startedAt = new Date(data.timestamp);
      startElapsedTimer();
      const ids = data.data?.persona_ids || [];
      ids.forEach(id => { state.personas[id] = { status: 'pending', stage: null }; });
    } else if (t.startsWith('stage_')) {
      state.current_persona = data.persona_id;
      state.current_stage = data.stage;
      if (data.persona_id && state.personas[data.persona_id]) {
        state.personas[data.persona_id].status = 'running';
        state.personas[data.persona_id].stage = data.stage;
      }
      if (!selectedPersona) selectedPersona = data.persona_id;
      if (t === 'stage_run_agent' && data.data?.fallback && data.persona_id && state.personas[data.persona_id]) {
        state.personas[data.persona_id].used_backup_model = true;
        state.personas[data.persona_id].backup_model_name = data.data?.message || '';
      }
    } else if (t === 'persona_completed') {
      const d = data.data || {};
      if (data.persona_id && state.personas[data.persona_id]) {
        const status = d.status || 'completed';
        Object.assign(state.personas[data.persona_id], {
          status: status, stage: '5/5',
          score: d.evaluation?.overall_score,
          phase_furthest: d.execution?.phase_furthest,
          duration: d.timing?.duration_seconds,
          result_data: d,
        });
      }
    } else if (t === 'persona_failed') {
      if (data.persona_id && state.personas[data.persona_id]) {
        Object.assign(state.personas[data.persona_id], { status: 'failed', error: data.data?.error, stage: data.data?.stage });
      }
    } else if (t === 'persona_timeout') {
      if (data.persona_id && state.personas[data.persona_id]) {
        state.personas[data.persona_id].status = 'timeout';
        state.personas[data.persona_id].error = data.data?.error;
      }
    } else if (t === 'agent_step') {
      if (data.persona_id && state.personas[data.persona_id]) {
        const p = state.personas[data.persona_id];
        p.current_step = data.data?.step_number;
        p.max_steps = data.data?.max_steps;
        p.current_url = data.data?.url;
        p.current_thinking = data.data?.thinking;
        if (!p.step_history) p.step_history = [];
        p.step_history.push({ step: data.data?.step_number, actions: data.data?.actions, url: data.data?.url, thinking: data.data?.thinking });
        if (p.step_history.length > 20) p.step_history = p.step_history.slice(-20);
      }
    } else if (t === 'loop_detected') {
      if (data.persona_id && state.personas[data.persona_id]) {
        const p = state.personas[data.persona_id];
        if (!p.loops) p.loops = [];
        p.loops.push(data.data);
      }
    } else if (t === 'batch_completed') {
      state.status = 'completed';
      state.current_persona = null;
      state.current_stage = null;
      stopElapsedTimer();
    }

    state.events_log.push(data);
    if (state.events_log.length > 200) state.events_log = state.events_log.slice(-200);
    renderAll();
  };
  evtSource.onerror = function() {
    document.getElementById('reconnecting').classList.add('show');
  };
}

// ---------------------------------------------------------------------------
// Elapsed timer
// ---------------------------------------------------------------------------
function startElapsedTimer() {
  stopElapsedTimer();
  elapsedTimer = setInterval(() => {
    if (startedAt) {
      const secs = Math.floor((Date.now() - startedAt.getTime()) / 1000);
      document.getElementById('elapsed').textContent = formatDuration(secs);
    }
  }, 1000);
}
function stopElapsedTimer() { if (elapsedTimer) { clearInterval(elapsedTimer); elapsedTimer = null; } }
function formatDuration(s) {
  const m = Math.floor(s / 60);
  const sec = s % 60;
  return m > 0 ? `${m}m ${sec}s` : `${sec}s`;
}

// ---------------------------------------------------------------------------
// Persona metadata fetch
// ---------------------------------------------------------------------------
async function fetchPersonaMetadata() {
  try {
    const res = await fetch('/api/personas');
    const list = await res.json();
    list.forEach(p => { personaMetadata[p.id] = p; });
    renderSidebar();
  } catch (e) { /* ignore */ }
}

// ---------------------------------------------------------------------------
// Render
// ---------------------------------------------------------------------------
function renderAll() {
  renderHeader();
  renderSidebar();
  renderPanel();
  renderFooter();
}

function renderHeader() {
  const badge = document.getElementById('batchBadge');
  badge.className = `badge badge-${state.status}`;
  badge.textContent = state.status.toUpperCase();
  document.getElementById('batchId').textContent = state.batch_id || '';
  if (state.status === 'running' && startedAt && !elapsedTimer) startElapsedTimer();
}

function langFlag(lang) {
  if (lang === 'fr') return '\uD83C\uDDEB\uD83C\uDDF7';
  if (lang === 'en') return '\uD83C\uDDEC\uD83C\uDDE7';
  return lang || '';
}
function langName(lang) {
  const names = { fr: 'Fran\u00E7ais', en: 'English', es: 'Espa\u00F1ol', de: 'Deutsch' };
  return names[lang] || lang?.toUpperCase() || '';
}

function renderSidebar() {
  const list = document.getElementById('personaList');
  const ids = Object.keys(state.personas);
  if (ids.length === 0) { list.innerHTML = '<div style="color:var(--text3);font-size:13px;padding:8px">No personas loaded</div>'; return; }

  list.innerHTML = ids.map(id => {
    const p = state.personas[id];
    const meta = personaMetadata[id];
    const isActive = id === selectedPersona;
    const scoreHtml = p.score != null ? `<span class="persona-score ${p.score >= 7 ? 'score-good' : p.score >= 5 ? 'score-mid' : 'score-bad'}">${p.score.toFixed(1)}</span>` : '';
    const stageText = p.stage || '';
    const stepText = p.current_step != null ? ` (${p.current_step}/${p.max_steps || '?'})` : '';
    const loopWarn = p.loops?.length ? `<span class="loop-indicator">\u26A0 ${p.loops.length}</span>` : '';
    const metaLine = meta ? `<div class="persona-detail">${langFlag(meta.language)} ${meta.travel_profile?.group_type || meta.group_type || ''}${meta.travel_profile?.budget_range ? ' | ' + meta.travel_profile.budget_range.split(' ')[0] : (meta.budget ? ' | ' + meta.budget.split(' ')[0] : '')}</div>` : '';

    return `<div class="persona-card ${isActive ? 'active' : ''}" onclick="selectPersona('${id}')">
      <div class="persona-icon ${p.status}"></div>
      <div class="persona-info">
        <div class="persona-name">${meta?.name || id.replace(/_/g, ' ')}${loopWarn}</div>
        <div class="persona-meta">${p.status}${stageText ? ' - ' + stageText : ''}${stepText}</div>
        ${metaLine}
      </div>
      ${scoreHtml}
    </div>`;
  }).join('');
}

// ---------------------------------------------------------------------------
// Panel
// ---------------------------------------------------------------------------
function renderPanel() {
  const panel = document.getElementById('panel');
  const empty = document.getElementById('emptyState');

  if (Object.keys(state.personas).length === 0 && state.status === 'idle') {
    panel.innerHTML = '';
    panel.appendChild(empty);
    loadResultsBrowser(panel);
    return;
  }
  if (empty.parentNode === panel) panel.removeChild(empty);

  const sel = selectedPersona;
  const p = sel ? state.personas[sel] : null;

  if (!p) {
    panel.innerHTML = '<div class="empty"><p>Select a persona from the sidebar</p></div>';
    return;
  }

  const rd = p.result_data;
  let html = '';

  // 1. Enhanced Persona Identity Card
  html += renderPersonaProfileEnhanced(sel, p);

  // 2. Persona Interests & Preferences
  html += renderPersonaInterests(sel);

  // 3. Error/Blockage Panel
  html += renderErrorPanel(p);

  // 4. Loop Alert
  html += renderLoopAlert(p);

  // 5. Stage Timeline
  html += renderStageTimeline(sel, p.stage, p.status);

  // 6. Live Step Progress
  html += renderStepProgress(p);

  // 7. KPI Metrics Dashboard
  if (rd) html += renderKPIDashboard(sel, p, rd);

  // 8. Execution Stats
  html += renderExecutionStats(p);

  // 9. Evaluation Card
  if (rd?.evaluation?.overall_score != null) {
    html += renderEvaluationCard(rd);
  }

  // 10. SWOT Matrix
  if (rd?.evaluation) html += renderSWOTMatrix(rd);

  // 11. Post-Execution Checklist
  if (rd) html += renderPostExecChecklist(sel, p, rd);

  // 12. Complete UX Feedback Card
  if (rd?.evaluation) html += renderUXFeedback(rd);

  // 13. Conversation Log (collapsible)
  html += renderConversationLog(rd);

  // 14. Agent Thoughts (collapsible)
  html += renderAgentThoughts(rd);

  // 11. Event Log
  html += `<div class="card">
    <h3>Event Log</h3>
    <div class="event-log" id="eventLog">${renderEventLog()}</div>
  </div>`;

  panel.innerHTML = html;

  // Draw radar chart
  const canvas = document.getElementById('radar');
  if (canvas && rd?.evaluation?.scores) drawRadar(canvas, rd.evaluation.scores);

  const logEl = document.getElementById('eventLog');
  if (logEl) logEl.scrollTop = logEl.scrollHeight;
}

// ---------------------------------------------------------------------------
// Section 1: Enhanced Persona Identity Card
// ---------------------------------------------------------------------------
function renderConvStyleVisual(cs) {
  const verbMap = { low: 25, medium: 55, high: 90 };
  const formalMap = { formal: 90, mixed: 55, casual: 20 };
  let html = '<div class="conv-style-visual">';
  html += `<div class="style-meter"><span class="meter-label">Verbosit\u00E9</span><div class="meter-bar"><div class="meter-fill" style="width:${verbMap[cs.verbosity] || 50}%"></div></div><span class="meter-value">${cs.verbosity}</span></div>`;
  html += `<div class="style-meter"><span class="meter-label">Formalit\u00E9</span><div class="meter-bar"><div class="meter-fill" style="width:${formalMap[cs.formality] || 50}%"></div></div><span class="meter-value">${cs.formality}</span></div>`;
  const bools = [
    { key: 'asks_questions', icon: '\u2753', label: 'Questions' },
    { key: 'expresses_frustration', icon: '\uD83D\uDE24', label: 'Frustration' },
    { key: 'changes_mind', icon: '\uD83D\uDD04', label: "Change d'avis" },
  ];
  bools.forEach(b => {
    const active = cs[b.key];
    html += `<div class="style-meter" style="${active ? '' : 'opacity:0.35'}"><span style="font-size:16px">${b.icon}</span><span class="meter-value">${b.label}</span></div>`;
  });
  html += '</div>';
  return html;
}

function renderPersonaProfileEnhanced(id, p) {
  const rd = p.result_data;
  const meta = personaMetadata[id];
  const runId = rd?.run_id || '';
  const model = rd?.meta?.llm_model_used || '';
  const avatarUrl = `https://api.dicebear.com/9.x/avataaars/svg?seed=${encodeURIComponent(meta?.name || id)}&backgroundColor=65c9ff,b6e3f4,c0aede,d1d4f9,ffd5dc,ffdfbf`;

  let html = `<div class="card">
    <div class="persona-profile-enhanced">
      <img class="persona-avatar-lg" src="${avatarUrl}" alt="${esc(meta?.name || id)}" />
      <div class="persona-header-info">
        <div class="pname" style="font-size:24px">${esc(meta?.name || id.replace(/_/g, ' '))}</div>
        <div class="age-lang" style="font-size:14px">${meta?.age ? meta.age + ' ans' : ''} ${meta?.language ? langFlag(meta.language) + ' ' + langName(meta.language) : ''}</div>
        <div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:4px">
          <span class="badge badge-${p.status}">${p.status.toUpperCase()}</span>
          ${p.used_backup_model ? '<span class="badge" style="background:#422006;color:#fbbf24;font-size:10px">BACKUP MODEL</span>' : ''}
        </div>
        <div style="font-size:11px;color:var(--text3);margin-top:4px">
          ${runId ? 'Run: ' + esc(runId) : ''}
          ${model ? ' | Model: ' + esc(model) : ''}
          ${p.duration != null ? ' | ' + formatDuration(Math.floor(p.duration)) : ''}
        </div>
      </div>
    </div>`;

  if (meta?.role) {
    html += `<div class="persona-role-quote">${esc(meta.role)}</div>`;
  }

  if (meta?.personality_traits?.length) {
    html += `<div class="section-label">Traits de personnalit\u00E9</div>
      <div class="pills">${meta.personality_traits.map(t => `<span class="trait-pill">${esc(t)}</span>`).join('')}</div>`;
  }

  if (meta?.conversation_style) {
    html += `<div class="section-label">Style de conversation</div>`;
    html += renderConvStyleVisual(meta.conversation_style);
  }

  // Conversation goals timeline (send_logs now visible)
  if (meta?.conversation_goals?.length) {
    const phasesReached = rd?.execution?.phases_reached || [];
    const isDone = p.status === 'completed' || p.status === 'timeout' || p.status === 'failed';
    html += `<div class="section-label">Objectifs de conversation</div><div class="goals-timeline">`;
    meta.conversation_goals.forEach(g => {
      const reached = phasesReached.includes(g.phase);
      const indicator = isDone ? (reached ? '\u2705' : '\u274C') : '\u23F3';
      html += `<div class="goal-row">
        <span class="goal-indicator">${indicator}</span>
        <span class="goal-phase">${esc(g.phase)}</span>
        <div class="goal-desc">${esc(g.goal?.substring(0, 120) || '')}${g.goal?.length > 120 ? '...' : ''}
          ${g.widget_interactions?.length ? `<div class="goal-widgets">${g.widget_interactions.map(w => `<span class="goal-widget-pill">${esc(w.split(':')[0].trim())}</span>`).join('')}</div>` : ''}
        </div>
      </div>`;
    });
    html += '</div>';
  }

  if (meta?.evaluation_weight_overrides && Object.keys(meta.evaluation_weight_overrides).length) {
    html += `<div class="section-label">Pond\u00E9rations d'\u00E9valuation</div><div class="weight-badges">`;
    for (const [axis, weight] of Object.entries(meta.evaluation_weight_overrides)) {
      html += `<span class="weight-badge">${axis.replace(/_/g, ' ')} x${weight}</span>`;
    }
    html += '</div>';
  }

  html += '</div>';
  return html;
}

// ---------------------------------------------------------------------------
// Section 1b: Persona Interests & Preferences
// ---------------------------------------------------------------------------
function renderPersonaInterests(id) {
  const meta = personaMetadata[id];
  if (!meta?.travel_profile) return '';
  const tp = meta.travel_profile;

  let html = `<div class="card"><h3>Centres d'int\u00E9r\u00EAt & Pr\u00E9f\u00E9rences</h3>`;

  if (tp.travelers) {
    const tv = tp.travelers;
    html += '<div class="group-visual">';
    for (let i = 0; i < (tv.adults || 0); i++) html += '<span class="group-icon">\uD83E\uDDD1</span>';
    for (let i = 0; i < (tv.children || 0); i++) html += '<span class="group-icon">\uD83E\uDDD2</span>';
    for (let i = 0; i < (tv.infants || 0); i++) html += '<span class="group-icon">\uD83D\uDC76</span>';
    const parts = [];
    if (tv.adults) parts.push(`${tv.adults} adulte${tv.adults > 1 ? 's' : ''}`);
    if (tv.children) parts.push(`${tv.children} enfant${tv.children > 1 ? 's' : ''}`);
    if (tv.infants) parts.push(`${tv.infants} b\u00E9b\u00E9${tv.infants > 1 ? 's' : ''}`);
    html += `<span style="margin-left:8px;font-size:13px;color:var(--text2)">${esc(tp.group_type)} \u2014 ${parts.join(', ')}</span>`;
    html += '</div>';
  }

  html += '<div class="badge-row">';
  if (tp.trip_type) html += `<span class="info-badge">\u2708\uFE0F ${esc(tp.trip_type)}</span>`;
  if (tp.trip_duration) html += `<span class="info-badge">\uD83D\uDCC5 ${esc(tp.trip_duration)}</span>`;
  if (tp.flexibility) html += `<span class="info-badge">\uD83D\uDD04 ${esc(tp.flexibility.replace(/_/g, ' '))}</span>`;
  if (tp.preferred_month) html += `<span class="info-badge">\u2600\uFE0F ${esc(tp.preferred_month)}</span>`;
  html += '</div>';

  if (tp.budget_range) {
    const budgetMatch = tp.budget_range.match(/(\d+)\s*-\s*(\d+)/);
    if (budgetMatch) {
      const lo = parseInt(budgetMatch[1]);
      const hi = parseInt(budgetMatch[2]);
      const maxBudget = 10000;
      const leftPct = Math.min((lo / maxBudget) * 100, 95);
      const widthPct = Math.min(((hi - lo) / maxBudget) * 100, 95 - leftPct);
      html += `<div class="budget-bar-container">
        <div class="td-label" style="font-size:10px;color:var(--text3);text-transform:uppercase">Budget: ${esc(tp.budget_range)}</div>
        <div class="budget-bar-track"><div class="budget-bar-fill" style="left:${leftPct}%;width:${widthPct}%"></div></div>
        <div class="budget-labels"><span>0</span><span>5000</span><span>10000 EUR</span></div>
      </div>`;
    } else {
      html += `<div style="margin-top:8px"><span class="info-badge">\uD83D\uDCB0 ${esc(tp.budget_range)}</span></div>`;
    }
  }

  if (tp.preferred_destinations?.length) {
    html += `<div class="section-label">Destinations pr\u00E9f\u00E9r\u00E9es</div><div class="interests-grid">`;
    tp.preferred_destinations.forEach(d => { html += `<span class="interest-tag destination">\uD83D\uDCCD ${esc(d)}</span>`; });
    html += '</div>';
  }

  if (meta.personality_traits?.length) {
    html += `<div class="section-label">Centres d'int\u00E9r\u00EAt</div><div class="interests-grid">`;
    meta.personality_traits.forEach(t => { html += `<span class="interest-tag activity">\u2728 ${esc(t)}</span>`; });
    html += '</div>';
  }

  if (tp.avoided?.length) {
    html += `<div class="section-label">\u00C0 \u00E9viter</div><div class="interests-grid">`;
    tp.avoided.forEach(d => { html += `<span class="interest-tag avoided">\u274C ${esc(d)}</span>`; });
    html += '</div>';
  }

  html += '</div>';
  return html;
}

// ---------------------------------------------------------------------------
// Section 2: Error/Blockage Panel
// ---------------------------------------------------------------------------
function renderErrorPanel(p) {
  if (p.status !== 'failed' && p.status !== 'timeout') return '';

  const isTimeout = p.status === 'timeout';
  const color = isTimeout ? 'var(--yellow)' : 'var(--red)';
  const icon = isTimeout ? '\u23F1' : '\u26A0';
  const title = isTimeout ? 'TIMEOUT' : 'FAILED';

  const error = p.error || '';
  let errorType = 'Unknown Error';
  let suggestion = '';

  if (p.stage === '0/5' || error.toLowerCase().includes('health check')) {
    errorType = 'LLM Health Check Failure';
    suggestion = 'OpenRouter API may be down or rate-limited. Check API key and model availability.';
  } else if (isTimeout) {
    errorType = 'Agent Timeout';
    suggestion = 'Agent exceeded time limit. Consider increasing timeout_per_persona_seconds or reducing max_steps.';
  } else if (error.toLowerCase().includes('browser') || error.toLowerCase().includes('playwright')) {
    errorType = 'Browser Error';
    suggestion = 'Browser crashed or page failed to load. Check target URL accessibility.';
  } else if (error.includes('404') || error.toLowerCase().includes('openrouter') || error.toLowerCase().includes('no endpoints')) {
    errorType = 'LLM API Error (Model Capability)';
    suggestion = 'The model may not support vision/images. Try a vision-capable model or set use_vision: false.';
  } else if (error.toLowerCase().includes('json') || error.toLowerCase().includes('agentoutput')) {
    errorType = 'LLM Output Parsing Error';
    suggestion = 'The model returned invalid JSON. Try a different model with better structured output support.';
  }

  return `<div class="card" style="border-color:${color}">
    <h3 style="color:${color}">${icon} ${title}</h3>
    <div class="meta-grid">
      <div class="meta-item"><div class="meta-label">Error Type</div><div class="meta-value" style="color:${color}">${errorType}</div></div>
      <div class="meta-item"><div class="meta-label">Failed At Stage</div><div class="meta-value">${p.stage || 'unknown'}</div></div>
    </div>
    <div style="margin-top:12px">
      <div class="meta-label">Error Message</div>
      <div class="meta-value" style="color:${color};font-family:monospace;font-size:12px;word-break:break-all;margin-top:4px">${esc(error)}</div>
    </div>
    ${suggestion ? `<div style="margin-top:12px"><div class="meta-label">Suggestion</div><div class="meta-value" style="color:var(--text2);font-size:13px;margin-top:4px">${suggestion}</div></div>` : ''}
  </div>`;
}

// ---------------------------------------------------------------------------
// Section 3: Loop Alert
// ---------------------------------------------------------------------------
function renderLoopAlert(p) {
  if (!p.loops || p.loops.length === 0) return '';
  const latest = p.loops[p.loops.length - 1];
  return `<div class="card" style="border-color:var(--purple)">
    <h3 style="color:var(--purple)">\u26A0 Loop Detected (${p.loops.length} total)</h3>
    <div class="meta-grid">
      <div class="meta-item"><div class="meta-label">Latest Pattern</div><div class="meta-value">${esc(latest.pattern || '')}</div></div>
      <div class="meta-item"><div class="meta-label">Type</div><div class="meta-value">${esc(latest.pattern_type || '')}</div></div>
      <div class="meta-item"><div class="meta-label">At Step</div><div class="meta-value">${latest.step_number || '?'}</div></div>
    </div>
    ${p.loops.length > 1 ? `<div style="margin-top:8px;font-size:12px;color:var(--text3)">Previous: ${p.loops.slice(0, -1).map(l => esc(l.pattern || '')).join(', ')}</div>` : ''}
  </div>`;
}

// ---------------------------------------------------------------------------
// Section 4: Stage Timeline
// ---------------------------------------------------------------------------
function renderStageTimeline(personaId, currentStage, status) {
  const stageTimestamps = {};
  state.events_log.forEach(e => {
    if (e.persona_id === personaId && e.type?.startsWith('stage_') && e.stage) {
      stageTimestamps[e.stage] = e.timestamp;
    }
  });
  const currentIdx = STAGES.findIndex(s => s.key === currentStage);
  const stagesHtml = STAGES.map((s, i) => {
    let cls = 'stage';
    if (status === 'completed') cls += ' done';
    else if (status === 'failed' || status === 'timeout') {
      if (i < currentIdx) cls += ' done';
      else if (i === currentIdx) cls += status === 'failed' ? ' failed-stage' : ' done';
    } else {
      if (i < currentIdx) cls += ' done';
      else if (i === currentIdx) cls += ' active';
    }
    const ts = stageTimestamps[s.key];
    const timeStr = ts ? new Date(ts).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit', second: '2-digit' }) : '';
    return `<div class="${cls}" title="${s.label}${timeStr ? ' at ' + timeStr : ''}">
      <div>${s.label}</div>
      ${timeStr ? `<div class="stage-time">${timeStr}</div>` : ''}
    </div>`;
  }).join('');
  return `<div class="card"><h3>Pipeline Progress</h3><div class="stages">${stagesHtml}</div></div>`;
}

// ---------------------------------------------------------------------------
// Section 5: Live Step Progress (Enhanced)
// ---------------------------------------------------------------------------
function renderStepProgress(p) {
  if (p.status !== 'running' || !p.current_step) return '';

  const pct = p.max_steps ? Math.round((p.current_step / p.max_steps) * 100) : 0;
  const recentSteps = (p.step_history || []).slice(-5);

  let html = `<div class="card">
    <h3>Agent Progress</h3>
    <div style="display:flex;align-items:center;gap:16px;margin-bottom:12px">
      <div style="font-size:36px;font-weight:700;color:var(--accent)">${p.current_step}<span style="font-size:18px;color:var(--text3)">/${p.max_steps || '?'}</span></div>
      <div style="flex:1">
        <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text3);margin-bottom:4px">
          <span>Steps</span><span>${pct}%</span>
        </div>
        <div class="score-bar-bg" style="height:10px">
          <div class="score-bar" style="width:${pct}%;background:var(--accent)"></div>
        </div>
      </div>
    </div>`;

  if (p.current_url) {
    html += `<div style="margin-bottom:8px;padding:6px 10px;background:var(--bg);border-radius:var(--radius);font-family:monospace;font-size:12px;color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${esc(p.current_url)}">\uD83C\uDF10 ${esc(p.current_url)}</div>`;
  }

  if (recentSteps.length) {
    html += '<div class="live-actions-feed">';
    recentSteps.forEach(s => {
      const actionStr = (s.actions || []).join(', ') || 'waiting...';
      html += `<div class="live-action-row">
        <span class="live-action-step">#${s.step}</span>
        <span class="live-action-name">${esc(actionStr)}</span>
        ${s.url ? `<span class="live-action-url" title="${esc(s.url)}">${esc(s.url)}</span>` : ''}
      </div>`;
    });
    html += '</div>';
  }

  if (p.current_thinking) {
    html += `<div class="thinking-snippet">\uD83E\uDDE0 ${esc(p.current_thinking)}</div>`;
  }

  if (p.loops?.length) {
    const latest = p.loops[p.loops.length - 1];
    html += `<div style="margin-top:8px;padding:6px 10px;background:rgba(168,85,247,0.1);border-radius:var(--radius);font-size:12px;color:var(--purple)">\u26A0 Loop: ${esc(latest.pattern || '')} (${p.loops.length} total)</div>`;
  }

  html += '</div>';
  return html;
}

// ---------------------------------------------------------------------------
// Section 6: Execution Stats
// ---------------------------------------------------------------------------
function renderExecutionStats(p) {
  const rd = p.result_data;
  if (!rd?.execution) return '';

  const ex = rd.execution;
  return `<div class="card">
    <h3>Execution Details</h3>
    <div class="meta-grid">
      <div class="meta-item"><div class="meta-label">Total Steps</div><div class="meta-value">${ex.total_steps ?? '-'}</div></div>
      <div class="meta-item"><div class="meta-label">Messages</div><div class="meta-value">${ex.total_messages ?? '-'}</div></div>
      <div class="meta-item"><div class="meta-label">Furthest Phase</div><div class="meta-value">${ex.phase_furthest || '-'}</div></div>
    </div>
    ${ex.phases_reached?.length ? `<div style="margin-top:12px"><div class="meta-label">Phases Reached</div><div class="pills">${ex.phases_reached.map(ph => `<span class="pill">${esc(ph)}</span>`).join('')}</div></div>` : ''}
    ${ex.widgets_interacted?.length ? `<div style="margin-top:8px"><div class="meta-label">Widgets Interacted</div><div class="pills">${ex.widgets_interacted.map(w => `<span class="pill">${esc(w)}</span>`).join('')}</div></div>` : ''}
  </div>`;
}

// ---------------------------------------------------------------------------
// Score helpers (backward compat: flat number OR {score, justification})
// ---------------------------------------------------------------------------
function getScore(scores, axis) {
  const v = scores[axis];
  if (v == null) return 0;
  if (typeof v === 'number') return v;
  if (typeof v === 'object') return v.score || 0;
  return 0;
}
function getJustification(scores, axis) {
  const v = scores[axis];
  if (v && typeof v === 'object') return v.justification || '';
  return '';
}

// ---------------------------------------------------------------------------
// Section 7: Evaluation Card (Scores + Radar)
// ---------------------------------------------------------------------------
function renderEvaluationCard(rd) {
  const scores = rd.evaluation.scores || {};

  return `<div class="card">
    <h3>Evaluation Scores</h3>
    <div class="scores-layout">
      <div>
        <div class="overall-score">
          <div class="number" style="color:${scoreColor(rd.evaluation.overall_score)}">${rd.evaluation.overall_score.toFixed(1)}</div>
          <div class="label">Overall Score / 10</div>
        </div>
        <canvas id="radar" width="280" height="280"></canvas>
      </div>
      <div>
        ${AXES.map(ax => {
          const v = getScore(scores, ax);
          return `<div class="score-row">
            <span class="axis">${ax.replace(/_/g, ' ')}</span>
            <div class="score-bar-bg"><div class="score-bar" style="width:${v*10}%;background:${scoreColor(v)}"></div></div>
            <span class="val" style="color:${scoreColor(v)}">${v.toFixed(1)}</span>
          </div>`;
        }).join('')}
      </div>
    </div>
  </div>`;
}

// ---------------------------------------------------------------------------
// Section 7b: KPI Metrics Dashboard
// ---------------------------------------------------------------------------
function renderKPIDashboard(id, p, rd) {
  const meta = personaMetadata[id];
  const ex = rd.execution || {};
  const eval_ = rd.evaluation || {};
  const timing = rd.timing || {};

  const totalGoals = meta?.conversation_goals?.length || 1;
  const phasesReached = ex.phases_reached || [];
  const phaseCompletion = Math.round((phasesReached.length / totalGoals) * 100);

  const totalSteps = ex.total_steps || 0;
  const totalMessages = ex.total_messages || 0;
  const convDensity = totalSteps > 0 ? (totalMessages / totalSteps).toFixed(2) : '-';

  const widgetsUsed = (ex.widgets_interacted || []).length;
  const expectedWidgets = meta?.conversation_goals
    ? meta.conversation_goals.reduce((sum, g) => sum + (g.widget_interactions || []).length, 0)
    : 1;
  const widgetRate = expectedWidgets > 0 ? Math.round((widgetsUsed / expectedWidgets) * 100) : 0;

  const duration = timing.duration_seconds;
  const timePerPhase = (duration && phasesReached.length > 0)
    ? (duration / phasesReached.length).toFixed(0)
    : '-';

  const overall = eval_.overall_score;

  return `<div class="card">
    <h3>KPI Metrics</h3>
    <div class="kpi-grid">
      <div class="kpi-item">
        <div class="kpi-value" style="color:${phaseCompletion >= 80 ? 'var(--green)' : phaseCompletion >= 50 ? 'var(--yellow)' : 'var(--red)'}">${phaseCompletion}%</div>
        <div class="kpi-label">Phase Completion</div>
        <div style="font-size:10px;color:var(--text3)">${phasesReached.length}/${totalGoals} phases</div>
      </div>
      <div class="kpi-item">
        <div class="kpi-value">${convDensity}</div>
        <div class="kpi-label">Conv. Density</div>
        <div style="font-size:10px;color:var(--text3)">messages/steps</div>
      </div>
      <div class="kpi-item">
        <div class="kpi-value" style="color:${widgetRate >= 70 ? 'var(--green)' : widgetRate >= 40 ? 'var(--yellow)' : 'var(--red)'}">${widgetRate}%</div>
        <div class="kpi-label">Widget Interaction</div>
        <div style="font-size:10px;color:var(--text3)">${widgetsUsed}/${expectedWidgets} widgets</div>
      </div>
      <div class="kpi-item">
        <div class="kpi-value">${timePerPhase}${timePerPhase !== '-' ? 's' : ''}</div>
        <div class="kpi-label">Time / Phase</div>
        <div style="font-size:10px;color:var(--text3)">${duration ? duration.toFixed(0) + 's total' : '-'}</div>
      </div>
      <div class="kpi-item">
        <div class="kpi-value">${totalSteps || '-'}</div>
        <div class="kpi-label">Total Steps</div>
        <div style="font-size:10px;color:var(--text3)">${totalMessages} messages</div>
      </div>
      <div class="kpi-item">
        <div class="kpi-value" style="color:${overall != null ? scoreColor(overall) : 'var(--text2)'}">${overall != null ? overall.toFixed(1) : '-'}</div>
        <div class="kpi-label">Overall Score</div>
        <div style="font-size:10px;color:var(--text3)">/10</div>
      </div>
    </div>
  </div>`;
}

// ---------------------------------------------------------------------------
// Section 8: SWOT Matrix
// ---------------------------------------------------------------------------
function renderSWOTMatrix(rd) {
  const eval_ = rd.evaluation || {};
  const strengths = eval_.strengths || [];
  const weaknesses = eval_.frustration_points || [];
  const opportunities = eval_.improvement_suggestions || [];
  const threats = eval_.threats || [];

  if (!strengths.length && !weaknesses.length && !opportunities.length && !threats.length) return '';

  function renderQuadrant(title, icon, items, cls) {
    const listHtml = items.length
      ? `<ul>${items.map(i => `<li>${esc(i)}</li>`).join('')}</ul>`
      : `<div style="font-size:11px;color:var(--text3);font-style:italic">Aucune donn\u00E9e</div>`;
    return `<div class="swot-quadrant ${cls}"><h4>${icon} ${title}</h4>${listHtml}</div>`;
  }

  return `<div class="card">
    <h3>Analyse SWOT</h3>
    <div class="swot-grid">
      ${renderQuadrant('Forces', '\uD83D\uDCAA', strengths, 'swot-strengths')}
      ${renderQuadrant('Faiblesses', '\u26A0', weaknesses, 'swot-weaknesses')}
      ${renderQuadrant('Opportunit\u00E9s', '\uD83D\uDE80', opportunities, 'swot-opportunities')}
      ${renderQuadrant('Menaces', '\uD83D\uDEE1\uFE0F', threats, 'swot-threats')}
    </div>
  </div>`;
}

// ---------------------------------------------------------------------------
// Section 9: Post-Execution Checklist
// ---------------------------------------------------------------------------
function renderPostExecChecklist(id, p, rd) {
  const meta = personaMetadata[id];
  const ex = rd.execution || {};
  const eval_ = rd.evaluation || {};
  const phasesReached = ex.phases_reached || [];

  if (p.status !== 'completed' && p.status !== 'timeout' && p.status !== 'failed') return '';

  const reportSent = phasesReached.includes('send_logs');
  const scores = eval_.scores || {};
  const allJustified = AXES.every(ax => {
    const v = scores[ax];
    return v && typeof v === 'object' && !!v.justification;
  });
  const feedbackComplete = !!(eval_.summary) && allJustified;
  const hasScreenshots = (rd.logs?.screenshot_paths?.length || 0) > 0;
  const screenshotCount = rd.logs?.screenshot_paths?.length || 0;
  const evalComplete = eval_.overall_score != null;

  function checkItem(pass, label, desc) {
    return `<div class="checklist-item ${pass ? 'pass' : 'fail'}">
      <span class="checklist-icon">${pass ? '\u2705' : '\u274C'}</span>
      <div class="checklist-text"><div class="cl-label">${label}</div><div class="cl-desc">${desc}</div></div>
    </div>`;
  }

  return `<div class="card">
    <h3>Checklist Post-Ex\u00E9cution</h3>
    <div class="checklist">
      ${checkItem(reportSent, 'Rapport envoy\u00E9', reportSent ? 'La phase send_logs a \u00E9t\u00E9 atteinte avec succ\u00E8s' : "Le persona n'a pas atteint la phase d'envoi du rapport")}
      ${checkItem(feedbackComplete, 'Feedback complet re\u00E7u', feedbackComplete ? 'R\u00E9sum\u00E9 + justifications des 9 axes pr\u00E9sents' : 'R\u00E9sum\u00E9 ou justifications incomplets')}
      ${checkItem(hasScreenshots, 'Screenshots captur\u00E9s', hasScreenshots ? screenshotCount + ' screenshot' + (screenshotCount > 1 ? 's' : '') + ' enregistr\u00E9' + (screenshotCount > 1 ? 's' : '') : 'Aucun screenshot captur\u00E9')}
      ${checkItem(evalComplete, '\u00C9valuation compl\u00E8te', evalComplete ? 'Score global: ' + eval_.overall_score.toFixed(1) + '/10' : '\u00C9valuation non disponible')}
    </div>
  </div>`;
}

// ---------------------------------------------------------------------------
// Section 10: Complete UX Feedback Card
// ---------------------------------------------------------------------------
function renderUXFeedback(rd) {
  const scores = rd.evaluation?.scores || {};
  const hasJustifications = AXES.some(ax => getJustification(scores, ax));
  const personaName = rd.persona?.name || 'Persona';
  const meta = personaMetadata[rd.persona?.id];
  const eval_ = rd.evaluation || {};

  let html = `<div class="card">
    <h3 style="color:var(--purple)">Ressenti UX Complet de ${esc(personaName)}</h3>`;

  if (eval_.summary) {
    html += `<div style="margin-bottom:16px;padding:16px;background:var(--bg);border-radius:var(--radius);border-left:4px solid var(--purple);font-size:14px;color:var(--text);line-height:1.7;white-space:pre-wrap">${esc(eval_.summary)}</div>`;
  }

  const strengths = eval_.strengths || [];
  const frustrations = eval_.frustration_points || [];
  const threats = eval_.threats || [];
  const suggestions = eval_.improvement_suggestions || [];

  if (strengths.length || frustrations.length || threats.length || suggestions.length) {
    html += '<div class="ux-feedback-sections">';
    if (strengths.length) html += `<div class="ux-section ux-good"><h4>\uD83D\uDFE2 Ce qui \u00E9tait bien</h4>${strengths.map(s => `<p>\u2022 ${esc(s)}</p>`).join('')}</div>`;
    if (frustrations.length) html += `<div class="ux-section ux-bad"><h4>\uD83D\uDD34 Ce qui \u00E9tait mauvais</h4>${frustrations.map(s => `<p>\u2022 ${esc(s)}</p>`).join('')}</div>`;
    if (threats.length) html += `<div class="ux-section ux-threats"><h4>\uD83D\uDFE0 Menaces per\u00E7ues</h4>${threats.map(s => `<p>\u2022 ${esc(s)}</p>`).join('')}</div>`;
    if (suggestions.length) html += `<div class="ux-section ux-opportunities"><h4>\uD83D\uDD35 Opportunit\u00E9s</h4>${suggestions.map(s => `<p>\u2022 ${esc(s)}</p>`).join('')}</div>`;
    html += '</div>';
  }

  // Phase completion comparison (send_logs now visible)
  const phasesReached = rd.execution?.phases_reached || [];
  if (meta?.conversation_goals?.length) {
    html += `<h4 style="color:var(--text3);margin-top:16px">Phases compl\u00E9t\u00E9es</h4><div class="phase-comparison">`;
    meta.conversation_goals.forEach(g => {
      const reached = phasesReached.includes(g.phase);
      html += `<span class="phase-chip ${reached ? 'reached' : 'missed'}" title="${esc(g.goal || '')}">${reached ? '\u2705' : '\u274C'} ${esc(g.phase)}</span>`;
    });
    html += '</div>';
  }

  if (hasJustifications) {
    html += `<h4 style="color:var(--text3);margin-top:16px">Justifications par axe</h4>`;
    AXES.forEach(ax => {
      const v = getScore(scores, ax);
      const just = getJustification(scores, ax);
      if (!just) return;
      html += `<div class="justification-card" style="border-left-color:${scoreColor(v)}">
        <div class="axis-header">
          <span class="axis-name">${ax.replace(/_/g, ' ')}</span>
          <span class="axis-score" style="color:${scoreColor(v)}">${v.toFixed(1)}/10</span>
        </div>
        <div class="axis-text">${esc(just)}</div>
      </div>`;
    });
  }

  if (rd.logs?.screenshot_paths?.length) {
    html += `<h4 style="color:var(--text3);margin-top:16px">Screenshots</h4><div class="screenshots-gallery">`;
    rd.logs.screenshot_paths.forEach((sp, i) => {
      const urlPath = '/screenshots/' + sp.replace(/^output[\\/]screenshots[\\/]/, '').replace(/\\/g, '/');
      html += `<div class="screenshot-thumb" onclick="openScreenshot('${esc(urlPath)}')">
        <img src="${urlPath}" alt="Step ${i}" loading="lazy" onerror="this.style.display='none'" />
        <div class="screenshot-label">Step ${i}</div>
      </div>`;
    });
    html += '</div>';
  }

  html += '</div>';
  return html;
}

// ---------------------------------------------------------------------------
// Section 9: Conversation Log
// ---------------------------------------------------------------------------
function renderConversationLog(rd) {
  if (!rd?.logs?.conversation) return '';
  const conv = rd.logs.conversation;
  let text = '';
  if (Array.isArray(conv)) {
    text = conv.map((c, i) => `[${i + 1}] ${typeof c === 'string' ? c : JSON.stringify(c)}`).join('\n\n');
  } else {
    text = String(conv);
  }
  return renderCollapsible('Conversation Log', esc(text), 'convLog');
}

// ---------------------------------------------------------------------------
// Section 10: Agent Thoughts
// ---------------------------------------------------------------------------
function renderAgentThoughts(rd) {
  if (!rd?.logs?.agent_thoughts?.length) return '';
  const text = rd.logs.agent_thoughts.map((t, i) => `[Thought ${i + 1}] ${t}`).join('\n\n');
  return renderCollapsible('Agent Thoughts', esc(text), 'agentThoughts');
}

function renderCollapsible(title, content, id) {
  if (!content) return '';
  return `<div class="card">
    <div class="collapsible-header" onclick="toggleCollapse('${id}')">
      <h3 style="margin-bottom:0">${title}</h3>
      <span class="arrow" id="${id}-arrow">\u25B6</span>
    </div>
    <div class="collapsible-body" id="${id}">${content}</div>
  </div>`;
}

function toggleCollapse(id) {
  const el = document.getElementById(id);
  const arrow = document.getElementById(id + '-arrow');
  if (!el) return;
  el.classList.toggle('open');
  if (arrow) arrow.classList.toggle('open');
}

// ---------------------------------------------------------------------------
// Event Log
// ---------------------------------------------------------------------------
function renderEventLog() {
  const events = (selectedPersona
    ? state.events_log.filter(e => (!e.persona_id || e.persona_id === selectedPersona) && e.type !== 'agent_step')
    : state.events_log.filter(e => e.type !== 'agent_step')
  ).slice(-50);

  return events.map(e => {
    const time = e.timestamp ? new Date(e.timestamp).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit', second: '2-digit' }) : '';
    const pid = e.persona_id || '';
    const msg = e.data?.message || e.type?.replace(/_/g, ' ') || '';
    const stage = e.stage ? `[${e.stage}] ` : '';
    const cls = e.type?.includes('failed') || e.type?.includes('timeout') ? 'error' :
                e.type?.includes('completed') ? 'success' :
                e.type?.includes('loop_detected') ? 'loop' : '';
    return `<div class="entry"><span class="time">${time}</span><span class="persona">${pid}</span><span class="msg ${cls}">${stage}${esc(msg)}</span></div>`;
  }).join('');
}

function renderFooter() {
  const ids = Object.keys(state.personas);
  const completed = ids.filter(id => state.personas[id].status === 'completed').length;
  const failed = ids.filter(id => state.personas[id].status === 'failed').length;
  const timeout = ids.filter(id => state.personas[id].status === 'timeout').length;

  document.getElementById('footerProgress').textContent = `${completed}/${ids.length} completed` +
    (failed ? ` | ${failed} failed` : '') + (timeout ? ` | ${timeout} timeout` : '');

  const scores = ids.map(id => state.personas[id].score).filter(s => s != null);
  if (scores.length) {
    const avg = scores.reduce((a, b) => a + b, 0) / scores.length;
    document.getElementById('footerAvg').textContent = `Avg: ${avg.toFixed(1)}/10`;
  } else {
    document.getElementById('footerAvg').textContent = '';
  }
}

// ---------------------------------------------------------------------------
// Radar Chart (Canvas)  handles both flat and {score,justification} formats
// ---------------------------------------------------------------------------
function drawRadar(canvas, scores) {
  const ctx = canvas.getContext('2d');
  const n = AXES.length;
  const cx = canvas.width / 2, cy = canvas.height / 2;
  const radius = Math.min(cx, cy) - 35;
  const angleStep = (2 * Math.PI) / n;
  const maxScore = 10;

  function getVal(axis) { return getScore(scores, axis); }

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  for (let ring = 2; ring <= 10; ring += 2) {
    ctx.beginPath();
    for (let i = 0; i <= n; i++) {
      const angle = i * angleStep - Math.PI / 2;
      const r = (ring / maxScore) * radius;
      const x = cx + r * Math.cos(angle), y = cy + r * Math.sin(angle);
      i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    }
    ctx.strokeStyle = 'rgba(255,255,255,0.08)';
    ctx.stroke();
  }

  AXES.forEach((axis, i) => {
    const angle = i * angleStep - Math.PI / 2;
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.lineTo(cx + radius * Math.cos(angle), cy + radius * Math.sin(angle));
    ctx.strokeStyle = 'rgba(255,255,255,0.1)';
    ctx.stroke();
    const lx = cx + (radius + 22) * Math.cos(angle);
    const ly = cy + (radius + 22) * Math.sin(angle);
    ctx.fillStyle = '#64748b';
    ctx.font = '9px system-ui';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    const label = axis.replace(/_/g, '\n').split('\n').map(w => w.charAt(0).toUpperCase() + w.slice(1));
    label.forEach((line, li) => {
      ctx.fillText(line, lx, ly + li * 10 - (label.length - 1) * 5);
    });
  });

  ctx.beginPath();
  AXES.forEach((axis, i) => {
    const angle = i * angleStep - Math.PI / 2;
    const val = getVal(axis);
    const r = (val / maxScore) * radius;
    const x = cx + r * Math.cos(angle), y = cy + r * Math.sin(angle);
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  });
  ctx.closePath();
  ctx.fillStyle = 'rgba(59, 130, 246, 0.15)';
  ctx.fill();
  ctx.strokeStyle = '#3b82f6';
  ctx.lineWidth = 2;
  ctx.stroke();

  AXES.forEach((axis, i) => {
    const angle = i * angleStep - Math.PI / 2;
    const val = getVal(axis);
    const r = (val / maxScore) * radius;
    ctx.beginPath();
    ctx.arc(cx + r * Math.cos(angle), cy + r * Math.sin(angle), 3.5, 0, 2 * Math.PI);
    ctx.fillStyle = '#3b82f6';
    ctx.fill();
  });
}

// ---------------------------------------------------------------------------
// Screenshot lightbox
// ---------------------------------------------------------------------------
function openScreenshot(url) {
  const lb = document.createElement('div');
  lb.className = 'screenshot-lightbox';
  lb.onclick = () => lb.remove();
  lb.innerHTML = `<img src="${url}" />`;
  document.body.appendChild(lb);
}

// ---------------------------------------------------------------------------
// Results Browser (idle mode)
// ---------------------------------------------------------------------------
async function loadResultsBrowser(panel) {
  try {
    const res = await fetch('/api/results');
    const results = await res.json();
    if (!results.length) return;

    let html = `<div class="card"><h3>Past Results</h3><table class="results-table">
      <thead><tr><th>Persona</th><th>Status</th><th>Score</th><th>Phase</th><th>Duration</th><th>Date</th></tr></thead><tbody>`;
    results.forEach(r => {
      const sc = r.score != null ? r.score.toFixed(1) : '-';
      const dur = r.duration != null ? formatDuration(Math.floor(r.duration)) : '-';
      const date = r.started_at ? new Date(r.started_at).toLocaleDateString('fr-FR') : '-';
      html += `<tr onclick="loadResult('${r.filename}')"><td>${r.persona_name || r.persona_id || r.filename}</td><td><span class="badge badge-${r.status}">${r.status}</span></td><td>${sc}</td><td>${r.phase_furthest || '-'}</td><td>${dur}</td><td>${date}</td></tr>`;
    });
    html += '</tbody></table></div>';
    panel.innerHTML += html;
  } catch (e) { /* ignore */ }
}

async function loadResult(filename) {
  if (resultCache[filename]) { showResultDetail(resultCache[filename]); return; }
  try {
    const res = await fetch(`/api/results/${filename}`);
    const data = await res.json();
    resultCache[filename] = data;
    showResultDetail(data);
  } catch (e) { /* ignore */ }
}

function showResultDetail(data) {
  const pid = data.persona?.id || 'unknown';
  selectedPersona = pid;
  state.personas[pid] = {
    status: data.status || 'completed',
    stage: '5/5',
    score: data.evaluation?.overall_score,
    phase_furthest: data.execution?.phase_furthest,
    duration: data.timing?.duration_seconds,
    result_data: data,
  };
  renderAll();
}

// ---------------------------------------------------------------------------
// Helpers
// ---------------------------------------------------------------------------
function selectPersona(id) { selectedPersona = id; renderAll(); }
function scoreColor(v) { return v >= 7 ? 'var(--green)' : v >= 5 ? 'var(--yellow)' : 'var(--red)'; }

const _escEl = document.createElement('span');
function esc(s) { _escEl.textContent = s || ''; return _escEl.innerHTML; }

// ---------------------------------------------------------------------------
// Init
// ---------------------------------------------------------------------------
connectSSE();
fetchPersonaMetadata();
fetch('/api/batch/status').then(r => r.json()).then(d => {
  if (d.batch_id || Object.keys(d.personas || {}).length) {
    state = d;
    if (state.started_at) { startedAt = new Date(state.started_at); startElapsedTimer(); }
    renderAll();
  }
}).catch(() => {});
</script>
</body>
</html>
